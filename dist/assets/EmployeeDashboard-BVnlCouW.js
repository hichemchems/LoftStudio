import{jsx as e,jsxs as a}from"react/jsx-runtime";import{useState as t,useEffect as s,useRef as i,useCallback as c}from"react";import{u as n}from"../main.js";import l from"axios";import{Bar as o}from"react-chartjs-2";import{Chart as r,CategoryScale as d,LinearScale as m,BarElement as h,Title as u,Tooltip as p,Legend as v}from"chart.js";import g from"socket.io-client";import"react-dom/client";import"react-router-dom";const N=({isAdmin:i=!1,onEdit:c,onDelete:n,onSelect:o})=>{const[r,d]=t([]),[m,h]=t(!0),[u,p]=t(""),v="http://localhost:3001/api/v1";s(()=>{g()},[]);const g=async()=>{try{const e=await l.get(`${v}/packages`);d(e.data.data||[])}catch(e){p("Failed to fetch packages")}finally{h(!1)}};return m?e("div",{className:"loading",children:"Loading packages..."}):u?e("div",{className:"error",children:u}):a("div",{className:"package-list",children:[e("h3",{children:"Packages"}),0===r.length?e("p",{children:"No packages available."}):e("div",{className:"package-grid",children:r.map(t=>a("div",{className:"package-card "+(t.is_active?"active":"inactive"),children:[e("h4",{children:t.name}),a("p",{className:"price",children:["€",t.price]}),e("p",{className:"status "+(t.is_active?"active":"inactive"),children:t.is_active?"Active":"Inactive"}),!i&&e("div",{className:"package-actions",children:e("button",{onClick:()=>o(t),className:"select-btn",children:"Sélectionner"})}),i&&a("div",{className:"package-actions",children:[e("button",{onClick:()=>c(t),className:"edit-btn",children:"Edit"}),e("button",{onClick:()=>(async(e,a)=>{try{await l.put(`${v}/packages/${e}/activate`,{is_active:!a}),g()}catch(t){p("Failed to update package status")}})(t.id,t.is_active),className:"activate-btn",children:t.is_active?"Deactivate":"Activate"}),e("button",{onClick:()=>n(t.id),className:"delete-btn",children:"Delete"})]})]},t.id))})]})};r.register(d,m,h,u,p,v);const b=()=>{const{user:r,logout:d,isAdmin:m}=n(),[h,u]=t({today:{totalPackages:0,totalClients:0,totalRevenue:0,commission:0},week:{totalPackages:0,totalClients:0,totalRevenue:0,commission:0},month:{totalPackages:0,totalClients:0,totalRevenue:0,commission:0}}),[p,v]=t(!0),[b,k]=t(null),[y,C]=t("today"),[f,w]=t(!1),[S,P]=t(!1),[D,R]=t(()=>{const e=localStorage.getItem("selectedPackage");return e?JSON.parse(e):null}),I=i(null),A=i(null),E="http://localhost:3001/api/v1",$=c(async()=>{const e=async e=>{try{const a=r.employee?.id||r.id;return(await l.get(`${E}/employees/${a}/stats?period=${e}`)).data.data}catch(a){throw a}};try{v(!0),k(null);const[a,t,s]=await Promise.all([e("today"),e("week"),e("month")]);u({today:{totalPackages:a.totalPackages,totalClients:a.totalClients,totalRevenue:a.totalRevenue,commission:a.commission},week:{totalPackages:t.totalPackages,totalClients:t.totalClients,totalRevenue:t.totalRevenue,commission:t.commission},month:{totalPackages:s.totalPackages,totalClients:s.totalClients,totalRevenue:s.totalRevenue,commission:s.commission}})}catch{k("Failed to load statistics")}finally{v(!1)}},[r,E]);s(()=>{if(r&&!m){$(),A.current=g(E.replace("/api/v1","")),A.current.on("dashboard-data-updated",()=>{$()});const e=()=>{const e=(new Date).toDateString();localStorage.getItem("lastStatsDate")!==e&&(localStorage.setItem("lastStatsDate",e),$())},a=new Date;localStorage.setItem("lastStatsDate",a.toDateString());const t=setInterval(e,6e4);return()=>{clearInterval(t),A.current&&A.current.disconnect()}}},[r,m,$,E]),s(()=>{const e=e=>{I.current&&!I.current.contains(e.target)&&P(!1)};return S&&document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[S]);const F=e=>new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(e),j=e=>{switch(P(!1),e){case"choosePackage":w(!0);break;case"viewToday":W("today");break;case"viewWeek":W("week");break;case"viewMonth":W("month")}},W=e=>{C(e)};if(p)return a("div",{className:"dashboard",children:[a("header",{className:"dashboard-header",children:[e("h1",{children:"Employee Dashboard"}),a("div",{className:"user-info",children:[a("span",{children:["Welcome, ",r?.name||r?.username]}),e("button",{onClick:d,className:"logout-btn",children:"Logout"})]})]}),e("main",{className:"dashboard-content",children:a("div",{className:"loading-container",children:[e("div",{className:"loading-spinner"}),e("p",{children:"Chargement de vos statistiques..."})]})})]});if(b)return a("div",{className:"dashboard",children:[a("header",{className:"dashboard-header",children:[e("h1",{children:"Employee Dashboard"}),a("div",{className:"user-info",children:[a("span",{children:["Welcome, ",r?.name||r?.username]}),e("button",{onClick:d,className:"logout-btn",children:"Logout"})]})]}),e("main",{className:"dashboard-content",children:a("div",{className:"error-message",children:[e("h2",{children:"Erreur de chargement"}),e("p",{children:b}),e("p",{children:"Il semble qu'il n'y ait pas encore de données de ventes dans le système."}),e("button",{onClick:$,className:"retry-btn",children:"Réessayer"})]})})]});const _=h[y],x={labels:["Total Clients","Chiffre d'Affaires","Commission"],datasets:[{label:`Statistiques pour ${y}`,data:[_.totalClients,_.totalRevenue||0,_.commission],backgroundColor:["rgba(255, 99, 132, 0.6)","rgba(255, 206, 86, 0.6)","rgba(75, 192, 192, 0.6)"],borderColor:["rgba(255, 99, 132, 1)","rgba(255, 206, 86, 1)","rgba(75, 192, 192, 1)"],borderWidth:1}]},L={responsive:!0,plugins:{legend:{position:"top"},title:{display:!0,text:`Statistiques Employé - ${y.charAt(0).toUpperCase()+y.slice(1)}`}},scales:{y:{beginAtZero:!0}}};return a("div",{className:"dashboard",children:[a("header",{className:"dashboard-header",children:[e("h1",{children:"Employee Dashboard"}),a("div",{className:"user-info",children:[a("span",{children:["Welcome, ",r?.name||r?.username]}),e("button",{onClick:()=>{P(!S)},className:"hamburger-btn",children:"☰"})]})]}),S&&a("div",{className:"hamburger-menu",ref:I,children:[e("button",{onClick:()=>j("choosePackage"),className:"menu-item",children:"Choisir Forfait"}),e("button",{onClick:()=>j("viewToday"),className:"menu-item",children:"Voir Aujourd'hui"}),e("button",{onClick:()=>j("viewWeek"),className:"menu-item",children:"Voir Semaine"}),e("button",{onClick:()=>j("viewMonth"),className:"menu-item",children:"Voir Mois"}),e("div",{className:"menu-divider"}),e("button",{onClick:d,className:"menu-item logout-item",children:"Déconnexion"})]}),a("main",{className:"dashboard-content",children:[D&&a("div",{className:"selected-package-card",children:[e("h3",{children:"Forfait Sélectionné"}),a("div",{className:"package-info",children:[e("h4",{children:D.name}),a("p",{className:"price",children:["€",D.price]})]})]}),a("div",{className:"employee-stats",children:[a("div",{className:"stat-card",children:[e("h3",{children:"Total Clients"}),e("p",{className:"stat-value",children:_.totalClients}),a("span",{className:"period-label",children:["(",y,")"]})]}),a("div",{className:"stat-card",children:[e("h3",{children:"Chiffre d'Affaires"}),e("p",{className:"stat-value revenue",children:F(_.totalRevenue||0)}),a("span",{className:"period-label",children:["(",y,")"]})]}),a("div",{className:"stat-card",children:[e("h3",{children:"Commission"}),e("p",{className:"stat-value commission",children:F(_.commission)}),a("span",{className:"period-label",children:["(",y,")"]})]})]}),e("div",{className:"chart-container",children:e(o,{data:x,options:L})}),a("div",{className:"period-selector",children:[e("h3",{children:"Période"}),a("div",{className:"period-buttons",children:[e("button",{className:"today"===y?"active":"",onClick:()=>W("today"),children:"Aujourd'hui"}),e("button",{className:"week"===y?"active":"",onClick:()=>W("week"),children:"Semaine"}),e("button",{className:"month"===y?"active":"",onClick:()=>W("month"),children:"Mois"})]})]})]}),f&&e("div",{className:"modal-overlay",children:a("div",{className:"modal-content package-modal",children:[e("h3",{children:"Choisir un Forfait"}),e(N,{isAdmin:!1,onSelect:async e=>{try{const a=r.employee?.id||r.id;await l.put(`${E}/employees/${a}/select-package`,{packageId:e.id}),R(e),localStorage.setItem("selectedPackage",JSON.stringify(e)),w(!1)}catch(a){R(e),localStorage.setItem("selectedPackage",JSON.stringify(e)),w(!1)}}}),e("div",{className:"modal-actions",children:e("button",{onClick:()=>w(!1),className:"close-btn",children:"Fermer"})})]})})]})};export{b as default};
